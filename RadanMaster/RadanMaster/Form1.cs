using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using DevExpress.XtraBars.Ribbon;
using System.Data.Entity;
using RadanMaster.Models;
using DevExpress.XtraGrid.Views.Base;
using DevExpress.XtraGrid.Views.Grid;
using DevExpress.XtraGrid.Columns;

using VaultItemProcessor;

using RadanInterface2;
using RadProject;
using System.IO;
using System.Xml.Serialization;
using System.Text.RegularExpressions;
using DevExpress.XtraGrid.Views.Grid.ViewInfo;
using DevExpress.Utils;

namespace RadanMaster
{
    public partial class Form1 : RibbonForm
    {
        RadanMaster.DAL.RadanMasterContext dbContext { get; set; }
        string radanProjectName { get; set; }
        RadanProject rPrj { get; set; }
        string symFolder { get; set; }
        RadanInterface radInterface { get; set; }

        public Form1()
        {
            InitializeComponent();
            // This line of code is generated by Data Source Configuration Wizard
            // Instantiate a new DBContext

            dbContext = new DAL.RadanMasterContext();
            radanProjectName = (string)AppSettings.AppSettings.Get("RadanProjectPathAndFile");
            barEditRadanProjectBrowse.EditValue = radanProjectName;
            symFolder = (string)AppSettings.AppSettings.Get("SymFilePath");
            radInterface = new RadanInterface();
            if (radInterface.Initialize())
                toolStripStatusLabel1.Text = "Connected to Radan";
            else
                toolStripStatusLabel1.Text = "Could not connect to Radan";

            // This line of code is generated by Data Source Configuration Wizard
            dbContext.OrderItems.Load();
            dbContext.Parts.Load();
            dbContext.Orders.Load();

            // This line of code is generated by Data Source Configuration Wizard
            orderItemsBindingSource.DataSource = dbContext.OrderItems.Local.ToBindingList();
            // This line of code is generated by Data Source Configuration Wizard
            // Instantiate a new DBContext
            // Call the LoadAsync method to asynchronously get the data for the given DbSet from the database.
            dbContext.Nests.LoadAsync().ContinueWith(loadTask =>
            {
                // Bind data to control when loading complete
                nestsBindingSource.DataSource = null;
            }, System.Threading.Tasks.TaskScheduler.FromCurrentSynchronizationContext());
        }

        private void importXmlFile(string fileName)
        {
            DailyScheduleAggregate dSchedule = new DailyScheduleAggregate(fileName);
            dSchedule.LoadFromFile();

            DirectoryInfo di = new DirectoryInfo(fileName);
            string batchName = di.Parent.Name;
            string schedName = di.Parent.Name;
            byte[] thumbnailByteArray = null;

            RadanInterface radanInterface = new RadanInterface();

            foreach (AggregateLineItem lineItem in dSchedule.AggregateLineItemList)
            {
                bool isBatch = batchName.ToUpper().Contains("BATCH");

                if (lineItem.Operations == "Laser")
                {
                    if ((isBatch && lineItem.IsStock == true) || (!isBatch && lineItem.IsStock == false))
                    {

                        string symName = symFolder + lineItem.Number + ".sym";
                        if (System.IO.File.Exists(symName))
                        {
                            char[] thumbnailCharArray = radanInterface.GetThumbnailDataFromSym(symName);
                            thumbnailByteArray = Convert.FromBase64CharArray(thumbnailCharArray, 0, thumbnailCharArray.Length);
                        }

                        Part newPart = new Part();

                        newPart = dbContext.Parts.Where(p => p.FileName == lineItem.Number).FirstOrDefault();
                        if (newPart == null)    // create a new part if we don't have it in the list
                        {
                            newPart = new Part();
                            newPart.FileName = lineItem.Number;
                            newPart.Description = lineItem.ItemDescription;
                            string modifiedThickness = lineItem.MaterialThickness.Substring(0, lineItem.MaterialThickness.LastIndexOf(" "));
                            newPart.Thickness = double.Parse(modifiedThickness);
                            newPart.Material = lineItem.Material;
                            newPart.Thumbnail = thumbnailByteArray;


                            dbContext.Parts.Add(newPart);
                            dbContext.SaveChanges();
                        }

                        foreach (OrderData oData in lineItem.AssociatedOrders)
                        {
                            Order searchOrder = new Order();
                            if (isBatch)
                                searchOrder = dbContext.Orders.Where(o => o.BatchName == batchName).FirstOrDefault();
                            else
                                searchOrder = dbContext.Orders.Where(o => o.OrderNumber == oData.OrderNumber).FirstOrDefault();
                            if (searchOrder == null)    // create new order if it doesn't already exist
                            {
                                searchOrder = new Order();
                                if (isBatch)
                                {
                                    searchOrder.BatchName = batchName;
                                    searchOrder.OrderNumber = "";
                                }
                                else
                                {
                                    searchOrder.OrderNumber = oData.OrderNumber;
                                    searchOrder.ScheduleName = schedName;
                                    searchOrder.BatchName = "";
                                }
                                searchOrder.IsComplete = false;
                                searchOrder.DueDate = DateTime.Now;
                                searchOrder.EntryDate = DateTime.Now;
                                searchOrder.IsBatch = isBatch;
                                dbContext.Orders.Add(searchOrder);
                                dbContext.SaveChanges();
                            }

                            OrderItem searchOrderItem = new OrderItem();
                            if (isBatch)
                                searchOrderItem = dbContext.OrderItems.Where(o => o.Order.BatchName == batchName).Where(o => o.Part.FileName == lineItem.Number).FirstOrDefault();
                            else
                                searchOrderItem = dbContext.OrderItems.Where(o => o.Order.OrderNumber == oData.OrderNumber).Where(o => o.Part.FileName == lineItem.Number).FirstOrDefault();
                            if (searchOrderItem == null)   // create a new order item if no match is found with this part number and order number
                            {
                                searchOrderItem = new OrderItem();
                                searchOrderItem.Order = searchOrder;
                                searchOrderItem.Part = newPart;
                                searchOrderItem.QtyRequired = oData.OrderQty * oData.UnitQty;
                                searchOrderItem.QtyNested = 0;
                                searchOrderItem.IsComplete = false;

                                dbContext.OrderItems.Add(searchOrderItem);
                                dbContext.SaveChanges();

                            }
                            else       // adjust existing order item with new quantities if it already exists
                            {
                                searchOrderItem.QtyRequired += oData.OrderQty * oData.UnitQty;
                                dbContext.SaveChanges();
                            }
                        }
                    }
                }
            }
            dbContext.SaveChanges();
        }

        private bool masterItemToRadanPart(OrderItem oItem)
        {
            try
            {
                rPrj = new RadanProject();
                rPrj = rPrj.LoadData(radanProjectName);
                string symName = oItem.Part.FileName;

                if (rPrj.Parts != null)
                {
                    RadanPart rPart = new RadanPart();
                    bool matchFound = false;
                    for (int i = 0; i < rPrj.Parts.Count(); i++)
                    {
                        rPart = rPrj.Parts.Part[i];
                        string radanName = Path.GetFileNameWithoutExtension(rPart.Symbol);
                        
                        if (radanName == symName && rPart.Bin == oItem.ID.ToString())
                        {
                            matchFound = true;
                            rPart.Number = oItem.QtyRequired;  // item still exists in project, just need to update 
                            rPrj.SaveData(radanProjectName);

                            oItem.IsInProject = true;
                            dbContext.SaveChanges();
                            break;
                        }
                    }

                    if (matchFound)
                    {
                        MessageBox.Show(Path.GetFileName(symName) + " already exists in this radan projecs, only qty required will be updated.");
                    }
                    else
                    {
                        //create new part in project
                        rPart = new RadanPart();
                        rPart.Symbol = symFolder + symName + ".sym";
                        rPart.Number = oItem.QtyRequired - oItem.QtyNested;
                        rPart.Made = 0;
                        rPart.ThickUnits = "in";
                        rPart.Thickness = oItem.Part.Thickness;
                        rPart.Material = oItem.Part.Material;
                        rPart.Bin = oItem.ID.ToString();


                        rPrj.AddPart(rPart);
                        rPrj.SaveData(radanProjectName);

                        oItem.IsInProject = true;
                        dbContext.SaveChanges();
                    }

                }
                

                return true;
            }
            catch (Exception ex)
            {
                return false;
            }

        }

        //private bool SyncRadanPartToMasterItem(RadanPart radPart)
        //{
        //    try
        //    {
        //        string symName = Path.GetFileNameWithoutExtension(radPart.Symbol);
        //        int binNumber = int.Parse(radPart.Bin);

        //        OrderItem masterItem = dbContext.OrderItems.Where(i => i.Part.FileName == symName).Where(i => i.ID == binNumber).FirstOrDefault();

        //        if (masterItem != null)
        //        {
        //            for (int i =0; i < radPart.UsedInNests.Count; i++)
        //            {
        //                int nestID = (int) radPart.UsedInNests[i].ID;
        //                string nestName = "";

        //                foreach(RadanNest nst in rPrj.Nests)
        //                {
        //                    if (nst.ID == nestID.ToString())
        //                        nestName = nst.FileName;
        //                }

        //                string pathName = Path.GetDirectoryName(radanProjectName) + "\\";
        //                Nest matchingNest = dbContext.Nests.Where(n => n.nestName == nestName).Where(n => n.nestPath == pathName).FirstOrDefault();

        //                if (matchingNest != null)
        //                {
        //                    if (!masterItem.AssociatedNests.Contains(matchingNest))
        //                    {
        //                        // if these were not associated with a nest previously, add them to the parts nested quantity
        //                        masterItem.AssociatedNests.Add(matchingNest);
        //                        //masterItem.QtyNested += radPart.UsedInNests[i].Made;
        //                    }
        //                    else
        //                    {   
        //                        // need to add a check here to make sure partial nests have not been synced before....
        //                    }

        //                }
        //            }
        //        }


        //        return true;
        //    }
        //    catch (Exception ex)
        //    {
        //        return false;
        //    }
        //}

        private bool SyncRadanToMaster()
        {
            try
            {
                if (saveRadan())
                {
                    rPrj = rPrj.LoadData(radanProjectName);
                    List<RadanNest> nestList = rPrj.Nests.ToList();
                    string nestPath = Path.GetDirectoryName(radanProjectName) + "\\";
                    string fileName = "";
                    int nestsImported = 0;
                    int nestsAlreadyInProject = 0;

                    foreach(RadanPart radanPart in rPrj.Parts.Part)     // loop through all the radan parts in this radan project
                    {
                        OrderItem masterItem = dbContext.OrderItems.Where(o => o.ID.ToString() == radanPart.Bin).FirstOrDefault();      // this item will exist
                        Nest masterNest = new Nest();
                        NestedParts masterNestedPart = new NestedParts();


                        foreach(SheetUsedInNest nestedRadanPart in radanPart.UsedInNests)   //loop through all the nested Parts in this Part
                        {
                            RadanNest radanNest = rPrj.Nests.Where(n => n.ID == nestedRadanPart.ID.ToString()).FirstOrDefault();        
                            masterNest = dbContext.Nests.Where(n => n.nestName == radanNest.FileName).Where(n => n.nestPath == nestPath).FirstOrDefault();    // this nest may or may not exist

                            if (masterNest==null)       // if master nest does not exist, create it
                            {
                                masterNest = new Nest();
                                masterNest.nestName = radanNest.FileName;
                                masterNest.nestPath = nestPath;
                                masterNest.NestedParts = new List<NestedParts>();
                            }

                            // search this nest for nested parts and create if they don't exist...
                            string symName = Path.GetFileNameWithoutExtension(radanPart.Symbol);
                            masterNestedPart = masterNest.NestedParts.Where(np => np.Part.FileName == symName).FirstOrDefault();
                            if (masterNestedPart == null)
                            {
                                // create new
                                masterNestedPart = new NestedParts();
                                masterNestedPart.Qty = nestedRadanPart.Made;
                                masterNestedPart.Part = masterItem.Part;
                                masterNest.NestedParts.Add(masterNestedPart);
                            }
                            else
                            {
                                // update existing
                                masterNestedPart.Qty = nestedRadanPart.Made;
                            }

                            if (masterItem.AssociatedNests == null)
                                masterItem.AssociatedNests = new List<Nest>();

                            if (!masterItem.AssociatedNests.Contains(masterNest))
                                masterItem.AssociatedNests.Add(masterNest);

                            dbContext.SaveChanges();
                        }

                    }

                    // make sure no nests got deleted from Radan project since last sync
                    foreach (Nest masterNest in dbContext.Nests.ToList().Where(n => n.nestPath == nestPath))
                    {
                        RadanNest radanNest = rPrj.Nests.Where(r => r.FileName == masterNest.nestName).FirstOrDefault();
                        if (radanNest == null)     // remove master nest if it no longer exists in radan project.
                        {
                            dbContext.Nests.Remove(masterNest);
                        }
                    }

                    #region oldcode
                    //// first make sure no nests got deleted from Radan project since last sync
                    //foreach (Nest masterNest in dbContext.Nests.ToList().Where(n => n.nestPath == nestPath))
                    //{
                    //    RadanNest radanNest = rPrj.Nests.Where(r => r.FileName == masterNest.nestName).FirstOrDefault();
                    //    if (radanNest == null)     // remove master nest if it no longer exists in radan project.
                    //    {
                    //        dbContext.Nests.Remove(masterNest);
                    //    }
                    //}

                    //// now update master list with new nests in radan project.
                    //foreach (RadanNest radanNest in rPrj.Nests.ToList())
                    //{

                    //    Nest masterNest = dbContext.Nests.Where(n => n.nestName == radanNest.FileName).Where(n => n.nestPath == nestPath).FirstOrDefault();
                    //    if (masterNest == null)     // add the radan nest to the master if it doesn't already exist
                    //    {                   
                    //        Nest newMasterNest = new Nest();
                    //        newMasterNest.NestedParts = new List<NestedParts>();
                    //        newMasterNest.nestName = radanNest.FileName;
                    //        newMasterNest.nestPath = nestPath;

                    //        foreach (NestsPartsMade n in radanNest.PartsMade)
                    //        {
                    //            foreach (NestPartsMadeListItem nestPartsMadeListItem in n.PartsListItems)
                    //            {
                    //                RadanPart nestedRadanPrt = rPrj.Parts.Part.Where(p => p.ID == nestPartsMadeListItem.ID).FirstOrDefault();
                    //                fileName = Path.GetFileNameWithoutExtension(nestedRadanPrt.Symbol);
                    //                Part nestedMasterPart = dbContext.Parts.Where(p => p.FileName == fileName).FirstOrDefault();
                    //                NestedParts nestedRadanItem = new NestedParts();
                    //                nestedRadanItem.Part = nestedMasterPart;
                    //                nestedRadanItem.Qty = nestPartsMadeListItem.Made;
                    //                newMasterNest.NestedParts.Add(nestedRadanItem);
                    //            }
                    //        }
                    //        dbContext.Nests.Add(newMasterNest);
                    //        nestsImported++;
                    //    }
                    //    else
                    //    {       
                    //        // we already have a matching master nest, we need to double check the associated quantities in the master nest to make sure the radan Nest didn't change
                    //        //  after it was originally synced to the master.

                    //        // TODO ************************make sure there is no records left over if a radan item should be deleted....**************
                    //        nestsAlreadyInProject++;





                    //        foreach (NestsPartsMade radanPartsMade in radanNest.PartsMade)
                    //        {
                    //            foreach (NestsPartsMade n in radanNest.PartsMade)
                    //            {
                    //                foreach (NestPartsMadeListItem nestPartsMadeListItem in n.PartsListItems)
                    //                {
                    //                    RadanPart nestedRadanPrt = rPrj.Parts.Part.Where(p => p.ID == nestPartsMadeListItem.ID).FirstOrDefault();
                    //                    fileName = Path.GetFileNameWithoutExtension(nestedRadanPrt.Symbol);
                    //                    Part nestedMasterPart = dbContext.Parts.Where(p => p.FileName == fileName).FirstOrDefault();
                    //                    NestedParts nestedRadanItem = new NestedParts();
                    //                    nestedRadanItem.Part = nestedMasterPart;
                    //                    nestedRadanItem.Qty = nestPartsMadeListItem.Made;

                    //                    NestPartsMadeListItem partMade = radanPartsMade.PartsListItems[0];
                    //                    RadanPart radanPart = rPrj.Parts.Part.Where(p => p.ID == partMade.ID).FirstOrDefault();
                    //                    fileName = Path.GetFileNameWithoutExtension(radanPartsMade.File);
                    //                    Part masterNestedPart = dbContext.Parts.Where(p => p.FileName == fileName).FirstOrDefault();
                    //                    NestedParts masterNestedItem = new NestedParts();
                    //                    masterNestedItem.Part = masterNestedPart;
                    //                    masterNestedItem.Qty = partMade.Made;

                    //                    NestedParts searchPart = masterNest.NestedParts.Where(p => p.Part.FileName == fileName).FirstOrDefault();
                    //                    if (searchPart != null)
                    //                    {
                    //                        // only update the quantities if the item already exists
                    //                        masterNest.NestedParts.Remove(searchPart);
                    //                        masterNest.NestedParts.Add(masterNestedItem);
                    //                    }
                    //                    else
                    //                    {
                    //                        // add a new part to the list
                    //                        masterNest.NestedParts.Add(masterNestedItem);
                    //                    }
                    //                }
                    //            }
                    //        }
                    //    }
                    //}



                    //dbContext.SaveChanges();

                    //RadanPart rPart = new RadanPart();

                    //for (int i = 0; i < rPrj.Parts.Count(); i++)
                    //{
                    //    rPart = rPrj.Parts.Part[i];
                    //    SyncRadanPartToMasterItem(rPart);
                    //}

                    //rPrj.SaveData(barEditRadanProjectBrowse.EditValue.ToString());
                    #endregion
                    dbContext.SaveChanges();
                    gridViewItems.RefreshData();
                }
                return true;
            }
            catch(Exception ex)
            {
                return false;
            }
        }

        private bool RetrieveSelectedRadanPartToMasterList()
        {
            try
            {
                SyncRadanToMaster();

                rPrj = new RadanProject();
                rPrj = rPrj.LoadData(radanProjectName);

                int[] rows = gridViewItems.GetSelectedRows();

                foreach(int i in rows)
                {
                    OrderItem item = (OrderItem) gridViewItems.GetRow(i);
                    //if (item.AssociatedNests == null)
                    //    item.AssociatedNests = new List<Nest>();

                    RadanPart rPart = GetPartFromRadanProject(rPrj, item.Part.FileName, item.ID);
                    if (rPart != null)
                    {
                        
                        
                        item.IsInProject = false;
                        if(rPart.Made ==0)
                            rPrj.Parts.Part.Remove(rPart);
                        else
                        {
                            rPart.Number = rPart.Made;
                        }
                        rPrj.SaveData(radanProjectName);
                    }
                }

                rPrj.SaveData(radanProjectName);

                // need to open current project here...
                string errMessage = "";
                string prjName = radInterface.getOpenProjectName(ref errMessage);
                radInterface.LoadProject(prjName);

                dbContext.SaveChanges();
                return true;
            }
            catch (Exception ex)
            {
                return false;
            }
        }

        private RadanPart GetPartFromRadanProject(RadanProject prj, string partName, int ID)
        {
            

            RadanPart rPart = new RadanPart();

            for (int i = 0; i < prj.Parts.Count(); i++)
            {
                rPart = prj.Parts.Part[i];
                string radanName = Path.GetFileNameWithoutExtension(rPart.Symbol);
                if ((radanName == (partName)) && (rPart.Bin == ID.ToString()))
                    return rPart;
            }

            return null;
        }

        private bool RefreshItemsGridFromActiveProject()
        {
            try
            {
                rPrj = rPrj.LoadData(radanProjectName);

                foreach (OrderItem item in dbContext.OrderItems)
                {
                    RadanPart rPart = GetPartFromRadanProject(rPrj, item.Part.FileName, item.ID);
                    if (rPart != null)
                        item.IsInProject = true;
                    else
                        item.IsInProject = false;
                }

                dbContext.SaveChanges();
                gridViewItems.RefreshData();


                return true;
            }
            catch (Exception ex)
            {
                return false;
            }
        }

        private bool saveRadan()
        {
            try
            {
                bool proceed = false;
                if (!radInterface.IsActive())
                {
                    DialogResult dialogResult = MessageBox.Show("Radan is not active, do you want to continue?", "Radan", MessageBoxButtons.YesNo);
                    if (dialogResult == DialogResult.Yes)
                    {
                        proceed = true;
                    }
                    else if (dialogResult == DialogResult.No)
                    {
                        proceed = false;
                    }
                }
                else
                    proceed = true;

                if (proceed)
                {
                    string errMessage = "";
                    string openNestName = radInterface.getOpenNestName(ref errMessage);
                    if (openNestName != "")
                        radInterface.SaveNest(ref errMessage);
                    if (radInterface.isProjectOpen(ref errMessage))
                        radInterface.SaveProject();

                    return true;
                }
                else
                    return false;
                
            }
            catch(Exception ex)
            {
                return false;
            }
        }

        #region gridView1 Event Handlers
        private void gridView1_RowUpdated(object sender, RowObjectEventArgs e)
        {
            dbContext.SaveChanges();
        }

        private void gridView1_RowDeleted(object sender, DevExpress.Data.RowDeletedEventArgs e)
        {
            dbContext.SaveChanges();
        }

        private void gridView1_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Delete && e.Modifiers == Keys.Control)
            {
                GridView view = sender as GridView;
                int numRows = view.SelectedRowsCount;
                if (MessageBox.Show("Delete " + numRows + " row(s)?", "Confirmation", MessageBoxButtons.YesNo) !=
                  DialogResult.Yes)
                    return;
               
                view.DeleteSelectedRows();
            }
        }

        private void barButtonSendSelectionToRadan_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            if (saveRadan())
            {

                for (int i = 0; i < gridViewItems.DataRowCount; i++)
                {
                    if (gridViewItems.IsRowSelected(i))
                    {

                        string partName = gridViewItems.GetRowCellValue(i, "Part.FileName").ToString();
                        string orderNumber = "";
                        if(gridViewItems.GetRowCellValue(i, "Order.OrderNumber")!=null)
                            orderNumber = gridViewItems.GetRowCellValue(i, "Order.OrderNumber").ToString();
                        string batchName = "";
                        if (gridViewItems.GetRowCellValue(i, "Order.BatchName")!=null)
                            batchName = gridViewItems.GetRowCellValue(i, "Order.BatchName").ToString();

                        OrderItem orderItem = dbContext.OrderItems.Where(oi => oi.Part.FileName == partName).Where(oi => oi.Order.OrderNumber == orderNumber).Where(oi => oi.Order.BatchName == batchName).FirstOrDefault();
                        if (orderItem != null)
                            masterItemToRadanPart(orderItem);
                    }
                }
            }
            
            // need to open current project here...
            string errMessage = "";
            string prjName = radInterface.getOpenProjectName(ref errMessage);
            radInterface.LoadProject(prjName);


            string path = barEditRadanProject.EditValue.ToString();
            rPrj.SaveData(path);

            gridViewItems.RefreshData();
        }

        private void barButtonRetrieveSelectionFromRadan_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            if (saveRadan())
            {

                RetrieveSelectedRadanPartToMasterList();



                gridViewItems.RefreshData();
            }
        }

        private void barButtonItemAdd_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            string addItemFileName = "";
            Order newOrder = new Order();
            // Show the dialog and get result.
            openFileDialogImport.Filter = "sym files (*.sym) | *.sym";
            DialogResult result = openFileDialogAddItem.ShowDialog();
            if (result == DialogResult.OK) // Test result.
            {
                AddItemDialog.AddItem addItemDialog = new AddItemDialog.AddItem();
                DialogResult addItemResult = addItemDialog.ShowDialog();


                if (addItemResult == DialogResult.OK)
                {
                    addItemFileName = (openFileDialogAddItem.FileName);
                    RadanInterface radanInterface = new RadanInterface();
                    //radanInterface.Initialize();

                    string name = System.IO.Path.GetFileNameWithoutExtension(addItemFileName);
                    string description = radanInterface.GetDescriptionFromSym(addItemFileName);
                    string thicknessStr = radanInterface.GetThicknessFromSym(addItemFileName);
                    double thickness = double.Parse(thicknessStr);
                    string material = radanInterface.GetMaterialTypeFromSym(addItemFileName);
                    char[] thumbnailCharArray = radanInterface.GetThumbnailDataFromSym(addItemFileName);
                    byte[] thumbnailByteArray = Convert.FromBase64CharArray(thumbnailCharArray, 0, thumbnailCharArray.Length);


                    Part newPart = dbContext.Parts.Where(p => p.FileName == name).FirstOrDefault();
                    if (newPart == null)
                    {
                        newPart = new Part();
                        newPart.FileName = name;
                        newPart.Description = description;
                        newPart.Thickness = thickness;
                        newPart.Material = material;
                        newPart.Thumbnail = thumbnailByteArray;

                        dbContext.Parts.Add(newPart);
                        dbContext.SaveChanges();


                    }

                    if(AddItemDialog.AddItem.lastOrderNumber != "")
                    {
                        newOrder = dbContext.Orders.Where(o => o.OrderNumber == AddItemDialog.AddItem.lastOrderNumber).FirstOrDefault();
                    }
                    if (AddItemDialog.AddItem.lastBatchName != "")
                    {
                        newOrder = dbContext.Orders.Where(o => o.BatchName == AddItemDialog.AddItem.lastBatchName).FirstOrDefault();
                    }

                    if (newOrder == null)
                    {
                        newOrder = new Order();
                        newOrder.IsComplete = false;
                        newOrder.DueDate = DateTime.Now;
                        newOrder.EntryDate = DateTime.Now;
                        newOrder.OrderItems = new List<OrderItem>();
                        newOrder.OrderNumber = AddItemDialog.AddItem.lastOrderNumber;
                        newOrder.ScheduleName = AddItemDialog.AddItem.lastSchedName;
                        newOrder.BatchName = AddItemDialog.AddItem.lastBatchName;
                        newOrder.IsBatch = AddItemDialog.AddItem.isBatch;

                        dbContext.Orders.Add(newOrder);
                        dbContext.SaveChanges();

                    }

                    OrderItem newItem = dbContext.OrderItems.Where(oitem => oitem.Order.OrderNumber == AddItemDialog.AddItem.lastOrderNumber).Where(oitem => oitem.Part.FileName == name)
                                                            .Where(oitem => oitem.Order.BatchName == AddItemDialog.AddItem.lastBatchName).FirstOrDefault();

                    //OrderItem newItem = dbContext.OrderItems.Where(oitem => oitem.Order == newOrder).Where(oitem => oitem.Part.FileName == name).FirstOrDefault();
                    if (newItem == null)
                    {
                        newItem = new OrderItem();
                        newItem.IsComplete = false;
                        newItem.Order = newOrder;
                        newItem.Part = newPart;
                        newItem.QtyRequired = int.Parse(AddItemDialog.AddItem.qty);
                        newItem.QtyNested = 0;

                        dbContext.OrderItems.Add(newItem);
                        dbContext.SaveChanges();
                    }
                    else
                    {
                        MessageBox.Show("This Order Item has already been entered. It will not be entered again");
                    }
                }
            }
        }

        private void barButtonItemImport_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            string importFileName = "";
            // Show the dialog and get result.
            openFileDialogImport.Filter = "xml files (*.xml) | *.xml";
            DialogResult result = openFileDialogImport.ShowDialog();
            if (result == DialogResult.OK) // Test result.
            {
                importFileName = (openFileDialogImport.FileName);
                importXmlFile(importFileName);
            }
        }

        private void barButtonBrowseRadanProject_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            openFileDialogProject.Filter = "rpd files (*.rpd) | *.rpd";
            DialogResult result = openFileDialogProject.ShowDialog();
            if (result == DialogResult.OK) // Test result.
            {
                string path = openFileDialogProject.FileName;

                radanProjectName = openFileDialogProject.FileName;
                barEditRadanProjectBrowse.EditValue = radanProjectName;

                rPrj = rPrj.LoadData(path);
            }
        }

        private void barButtonUpdateFromRadan_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            SyncRadanToMaster();

            
        }

        private void barEditRadanProjectBrowse_EditValueChanged(object sender, EventArgs e)
        {
            AppSettings.AppSettings.Set("RadanProjectPathAndFile", barEditRadanProjectBrowse.EditValue);
            RefreshItemsGridFromActiveProject();
        }

        private void gridViewItems_RowClick(object sender, RowClickEventArgs e)
        {
            List<Nest> filteredNests = new List<Nest>();
            List<Nest> filteredNestsSubList = new List<Nest>();

            int[] rows = gridViewItems.GetSelectedRows();

            if (rows.Count() == 1)
            {
                OrderItem selectedItem = (OrderItem)gridViewItems.GetRow(rows[0]);

                if(selectedItem.AssociatedNests!=null)
                    nestsBindingSource.DataSource = selectedItem.AssociatedNests.ToList();

                //if (selectedItem.AssociatedNests != null)
                //{
                //    if (selectedItem.AssociatedNests.Count > 0)
                //    {
                //        foreach (Nest n in selectedItem.AssociatedNests)
                //        {
                //            filteredNestsSubList = dbContext.Nests.Where(nst => nst.nestName == n.nestName).Where(nst => nst.nestPath == n.nestPath).ToList();
                //            filteredNests.AddRange(filteredNestsSubList);
                //        }
                //    }
                //}
            }

            //nestsBindingSource.DataSource = filteredNests;

           
            
            gridViewNests.RefreshData();
        }

        private void gridControlItems_MouseDoubleClick(object sender, MouseEventArgs e)
        {
            GridHitInfo hinfo = gridViewItems.CalcHitInfo(e.Location);
            if (hinfo.Column == gridViewItems.Columns[1])
            {
                gridViewItems.Columns[1].OptionsColumn.AllowEdit = true;
                gridViewItems.ShowEditor();
            }
            ((DXMouseEventArgs)e).Handled = true;
        }

        private void gridViewItems_HiddenEditor(object sender, EventArgs e)
        {
            gridViewItems.Columns[1].OptionsColumn.AllowEdit = false;
        }

        private void gridViewItems_CustomUnboundColumnData(object sender, CustomColumnDataEventArgs e)
        {
            if (e.Column.FieldName == "calcQtyNested")
            {
                int origQtyNested = 0;

                if (rPrj == null)
                    e.Value = "??";
                else
                {
                    int totalNested = 0;
                    OrderItem calcItem = (OrderItem)e.Row;
                    origQtyNested = calcItem.QtyNested;

                    if (calcItem.AssociatedNests != null)
                    {
                        foreach (Nest associatedNest in calcItem.AssociatedNests)
                        {
                            if (associatedNest.NestedParts != null)
                            {
                                foreach (NestedParts p in associatedNest.NestedParts)
                                {
                                    if (p.Part == calcItem.Part && calcItem.IsInProject == true)
                                        totalNested += p.Qty;
                                }
                            }
                        }

                        e.Value = calcItem.QtyNested += totalNested;

                        // for some reason e.Value gets written to calcItem.QtyNested.
                        //    because this event fires multiple times, the quantity nested gets incremented multiple times.
                        //    This is not what we want so the following line is a work around.
                        calcItem.QtyNested = origQtyNested;
                        
                    }
                }
            }
        }


        #endregion

        private void gridViewNests_CustomUnboundColumnData(object sender, CustomColumnDataEventArgs e)
        {
            if (e.Column.FieldName == "QtyOnNest")
            {
                Nest associatedNest = (Nest)e.Row;
                int[] rows = gridViewItems.GetSelectedRows();
                OrderItem selectedItem = (OrderItem)gridViewItems.GetRow(rows[0]);

                NestedParts part = associatedNest.NestedParts.Where(n => n.Part.FileName == selectedItem.Part.FileName).FirstOrDefault();

                if(part!=null)
                    e.Value = part.Qty;
            }
        }
    }
}
